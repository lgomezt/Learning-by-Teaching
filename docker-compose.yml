# docker-compose.yml

services:
  frontend:
    build:
      context: . # Use root folder as context
      dockerfile: ./frontend/Dockerfile # Path to the Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL}
        - VITE_AUTH0_DOMAIN=${VITE_AUTH0_DOMAIN}
        - VITE_AUTH0_CLIENT_ID=${VITE_AUTH0_CLIENT_ID}
        - VITE_AUTH0_AUDIENCE=${VITE_AUTH0_AUDIENCE}
        
    restart: always

  backend:
    build:
      context: . # Use root folder as context
      dockerfile: ./backend/Dockerfile # Path to the Dockerfile
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials.json

      # --- These variables are now read by your new python config ---
      - DB_HOST=cloud-sql-proxy  # <-- CRITICAL: This MUST match the proxy service name
      - DB_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    
    volumes:
      - /data/coolify/secrets/credentials.json:/app/credentials.json:ro

    depends_on:
      - cloud-sql-proxy
    restart: always

  cloud-sql-proxy:
    image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:latest
    command:
      - "--address=0.0.0.0"
      # These flags tell the proxy to listen on port 5432
      # and use the credentials file Coolify will inject.
      - "--port=5432"
      - "--credentials-file=/app/credentials.json"
      # This variable will be set in Coolify with your instance name
      # Format: PROJECT_ID:REGION:INSTANCE_NAME
      - "${DB_INSTANCE_CONNECTION_NAME}"
    environment:
      # This path must match the one in the backend service
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials.json

    volumes:
      - /data/coolify/secrets/credentials.json:/app/credentials.json:ro

    restart: always